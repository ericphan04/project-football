<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Available Tickets</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', sans-serif;
        }

        .ticket-header {
            background-color: #30003a;
            color: white;
            padding: 2rem;
            text-align: center;
        }

        canvas {
            display: block;
            margin: 2rem auto;
            border: 1px solid #ccc;
        }

        .legend {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }

        .legend-item {
            display: inline-block;
            margin: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            color: #fff;
        }

        .area-A { background-color: #f94144; }
        .area-B { background-color: #f3722c; }
        .area-C { background-color: #f9c74f; }
        .area-D { background-color: #90be6d; }
        .area-E { background-color: #43aa8b; }
        .area-F { background-color: #577590; }
    </style>
</head>

<body>
<div class="ticket-header">
    <h2 th:text="${match.matchTitle}">Match Title</h2>
    <p th:text="${#temporals.format(match.matchStartTime, 'dd MMM yyyy, HH:mm')}">Match Time</p>
</div>

<canvas id="stadiumCanvas" width="1000" height="700"></canvas>

<div class="legend">
    <span class="legend-item area-A">Area A</span>
    <span class="legend-item area-B">Area B</span>
    <span class="legend-item area-C">Area C</span>
    <span class="legend-item area-D">Area D</span>
    <span class="legend-item area-E">Area E</span>
    <span class="legend-item area-F">Area F</span>
</div>

<!-- Modal -->
<div class="modal fade" id="ticketModal" tabindex="-1" aria-labelledby="ticketModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="http://localhost:8080/ticket/bookingticket">
        <div class="modal-header">
          <h5 class="modal-title" id="ticketModalLabel">Ticket Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p><strong>Title:</strong> <span id="modalTicketTitle"></span></p>
          <p><strong>Type:</strong> <span id="modalTicketType"></span></p>
          <p><strong>Area:</strong> <span id="modalTicketArea"></span></p>
          <p><strong>Remaining:</strong> <span id="modalTicketAmount"></span></p>
          <input type="hidden" name="ticketId" id="hiddenTicketId">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Book Now</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script th:inline="javascript">
    const tickets = JSON.parse(/*[[${ticketsJson}]]*/ '[]');

    const canvas = document.getElementById('stadiumCanvas');
    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;

    const baseColors = {
        'A': '#f94144', 'B': '#f3722c', 'C': '#f9c74f',
        'D': '#90be6d', 'E': '#43aa8b', 'F': '#577590'
    };

    const typeShades = {
        'VIP': 0.9,
        'Standard': 1.3
    };

    const positionMap = {};

    function shadeColor(hex, factor) {
        let r = parseInt(hex.substring(1, 3), 16);
        let g = parseInt(hex.substring(3, 5), 16);
        let b = parseInt(hex.substring(5, 7), 16);
        r = Math.min(255, Math.floor(r * factor));
        g = Math.min(255, Math.floor(g * factor));
        b = Math.min(255, Math.floor(b * factor));
        return `rgb(${r}, ${g}, ${b})`;
    }

    function drawOvalStadiumField() {
        ctx.beginPath();
        ctx.ellipse(centerX, centerY, 180, 100, 0, 0, 2 * Math.PI);
        ctx.fillStyle = '#4CAF50';
        ctx.fill();
        ctx.strokeStyle = '#2e7d32';
        ctx.lineWidth = 4;
        ctx.stroke();
    }

    function drawTicketRings() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawOvalStadiumField();

        const vipTickets = tickets.filter(t => t.ticketType === 'VIP');
        const stdTickets = tickets.filter(t => t.ticketType === 'Standard');

        const drawRing = (ticketList, innerA, outerA, innerB, outerB) => {
            const step = (2 * Math.PI) / ticketList.length;
            ticketList.forEach((ticket, i) => {
                const start = i * step;
                const end = start + step;
                ctx.beginPath();
                for (let angle = start; angle <= end; angle += 0.01) {
                    const x = centerX + outerA * Math.cos(angle);
                    const y = centerY + outerB * Math.sin(angle);
                    if (angle === start) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                for (let angle = end; angle >= start; angle -= 0.01) {
                    const x = centerX + innerA * Math.cos(angle);
                    const y = centerY + innerB * Math.sin(angle);
                    ctx.lineTo(x, y);
                }
                ctx.closePath();
                const base = baseColors[ticket.ticketArea] || '#999';
                ctx.fillStyle = shadeColor(base, typeShades[ticket.ticketType] || 1);
                ctx.fill();
                ctx.strokeStyle = '#333';
                ctx.stroke();

                const mid = (start + end) / 2;
                const labelX = centerX + ((outerA + innerA) / 2) * Math.cos(mid);
                const labelY = centerY + ((outerB + innerB) / 2) * Math.sin(mid);
                ctx.fillStyle = '#000';
                ctx.font = 'bold 10px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`${ticket.ticketTitle} (${ticket.ticketAmount})`, labelX, labelY);

                positionMap[ticket.ticketId] = { start, end, innerA, outerA, innerB, outerB, ticket };
            });
        }

        drawRing(vipTickets, 120, 170, 70, 100);
        drawRing(stdTickets, 200, 260, 130, 160);
    }

    canvas.addEventListener('click', function (e) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const dx = x - centerX;
        const dy = y - centerY;
        const angle = (Math.atan2(dy, dx) + 2 * Math.PI) % (2 * Math.PI);

        for (let ticketId in positionMap) {
            const pos = positionMap[ticketId];
            const xA = dx / pos.outerA;
            const yB = dy / pos.outerB;
            const r = Math.sqrt(xA * xA + yB * yB);
            if (angle >= pos.start && angle <= pos.end && r >= pos.innerA / pos.outerA && r <= 1) {
                const t = pos.ticket;
                document.getElementById('modalTicketTitle').textContent = t.ticketTitle;
                document.getElementById('modalTicketType').textContent = t.ticketType;
                document.getElementById('modalTicketArea').textContent = t.ticketArea;
                document.getElementById('modalTicketAmount').textContent = t.ticketAmount;
                document.getElementById('hiddenTicketId').value = t.ticketId;
                const modal = new bootstrap.Modal(document.getElementById('ticketModal'));
                modal.show();
                break;
            }
        }
    });

    drawTicketRings();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
